---
# openwrt-upgrade.yml

- name: Update and upgrade OpenWrt packages
  hosts: openwrt
  gather_facts: false
  serial: 1

  tasks:
    - name: Backup config before upgrade
      ansible.builtin.raw: sysupgrade -b {{ backup_path }}
      when: backup_config | bool

    - name: Run opkg update
      ansible.builtin.raw: opkg update
      register: opkg_update
      changed_when: true
      ignore_errors: true

    - name: List upgradable packages (excluding ignored)
      ansible.builtin.raw: >
        opkg list-upgradable | grep -vE '{{ opkg_upgrade_ignore }}' | cut -f 1 -d ' ' || true
      register: upgradable
      changed_when: false

    - name: Upgrade packages
      ansible.builtin.raw: >
        opkg list-upgradable | grep -vE '{{ opkg_upgrade_ignore }}' | cut -f 1 -d ' ' | xargs -r opkg upgrade
      when: upgradable.stdout | length > 0
      register: upgrade_result
      changed_when: upgrade_result.rc == 0 and 'Upgrading' in upgrade_result.stdout

    - name: Reboot if critical package upgraded
      ansible.builtin.shell: |
        if echo "{{ upgrade_result.stdout }}" | grep -qE '{{ critical_packages }}'; then
          echo "Critical package upgraded â†’ rebooting..."
          reboot
        fi
      async: 45
      poll: 0
      ignore_errors: true
      when: upgrade_result.changed | default(false)

    - name: Wait for router to come back
      ansible.builtin.wait_for_connection:
        delay: 30
        timeout: 120
        sleep: 10
      when:
        - upgrade_result.changed | default(false)
        - critical_packages | default('') in upgrade_result.stdout
