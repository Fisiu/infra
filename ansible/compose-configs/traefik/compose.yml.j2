---
# compose.yml

services:
  traefik:
    image: {{ traefik_image }}
    container_name: {{ traefik_container_name }}
    restart: {{ restart_policy }}
    security_opt:
      - no-new-privileges
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    ports:
      - "{{ traefik_http_port }}:80"
      - "{{ traefik_https_port }}:443"
      - "{{ traefik_dashboard_port }}:8080"
    extra_hosts:
      - host.docker.internal:host-gateway
{% for hostname, ip in traefik_extra_hosts.items() %}
      - "{{ hostname }}:{{ ip }}"
{% endfor %}
    environment:
      - CF_API_EMAIL=${CF_API_EMAIL}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
      - CF_ZONE_API_TOKEN=${CF_ZONE_API_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic:/etc/traefik/dynamic:ro
      - ./letsencrypt:/letsencrypt
      - ./logs:/logs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`{{ traefik_dashboard_host }}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=production"
      - "traefik.http.routers.dashboard.tls.domains[0].main={{ vault_traefik_domain }}"
      - "traefik.http.routers.dashboard.tls.domains[0].sans=*.{{ vault_traefik_domain }}"
      - "traefik.http.routers.dashboard.middlewares=lan-only@file,error-pages@file"
    depends_on:
      error-pages: {condition: service_healthy}

  error-pages:
    image: {{ error_pages_image }}
    container_name: {{ error_pages_container_name }}
    restart: {{ restart_policy }}
    security_opt:
      - no-new-privileges
    environment:
      - TEMPLATE_NAME={{ error_pages_template }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.error-pages.loadbalancer.server.port=8080"
      - "traefik.http.routers.error-pages.rule=HostRegexp(`.+`)"
      - "traefik.http.routers.error-pages.priority=10"
      - "traefik.http.routers.error-pages.entrypoints=websecure"
      - "traefik.http.routers.error-pages.tls.certresolver=production"

networks:
  default:
    name: {{ docker_network_name }}
    external: true
